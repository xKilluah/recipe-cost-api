name: Deploy to Render (hook + health check)

on:
  push:
    branches: [ main ]

# Prevent overlapping deploys
concurrency:
  group: recipe-cost-api-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deployment (Deploy Hook)
        run: |
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

      # Optional but recommended: wait until the app responds 200 on "/"
       - name: Wait for health check
        env:
          URL: https://recipe-cost-api.onrender.com/
        run: |
          echo "Waiting for $URL to become healthy (2xx/3xx)…"
          for i in {1..60}; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            echo "Attempt $i -> HTTP $code"
            # consider 2xx and 3xx as healthy
            if [ "$code" -ge 200 ] && [ "$code" -lt 400 ]; then
              echo "Health check OK ✅"
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed after 5 minutes ❌"
          exit 1
