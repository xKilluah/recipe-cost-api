name: Deploy to Render (hook + health check)

on:
  push:
    branches: [ main ]

# Prevent overlapping deploys
concurrency:
  group: recipe-cost-api-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deployment (Deploy Hook)
        run: |
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

      # Optional but recommended: wait until the app responds 200 on "/"
      - name: Wait for health check
        env:
          URL: https://recipe-cost-api.onrender.com/
        run: |
          echo "Waiting for $URL to return 200..."
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$code" = "200" ]; then
              echo "Health check OK (200) ✅"
              exit 0
            fi
            echo "Attempt $i: got $code, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 5 minutes ❌"
          exit 1
